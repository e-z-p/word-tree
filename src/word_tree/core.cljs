(ns word-tree.core
  (:require
    [reagent.core :as r]
    [word-tree.suffix-tree :as sfx]
    [clojure.string :as str]))

;; -------------------------
;; Views

(def dfw-quote "One reason for my willingness to speak publicly on a subject for which I am sort of underqualified is that it affords me a chance to declaim for you a short story of Kafka's that I have given up teaching in literature classes and miss getting to read aloud. Its English title is \"A Little Fable\"; \"Alas,\" said the mouse, \"the world is growing smaller every day. At the beginning it was so big that I was afraid, I kept running and running, and I was glad when at last I saw walls far away to the right and left, but these long walls have narrowed so quickly that I am in the last chamber already, and there in the corner stands the trap that I must run into.\" \"You only need to change your direction,\" said the cat, and ate it up. For me, a signal frustration in trying to read Kafka with college students is that it is next to impossible to get them to see that Kafka is funny ... Nor to appreciate the way funniness is bound up with the extraordinary power of hisstories. Because, of course, great short stories and great jokes have a lot in common. Both depend on what communication-theorists sometimes call \"exformation,\" which is a certain quantity of vital information removed from\nbut evoked by a communication in such a way as to cause a kind of explosion of associative connections within the recipient. This is probably why the effect of both short stories and jokes often feels sudden and percussive, like the venting of a long-stuck valve. It's not for nothing that Kafka spoke of literature as \"a hatchet with which we chop at the frozen seas inside us.\" Nor is it an accident that the technical achievement of great short stories is often called \"compression\"-for both the pressure and the release are already inside the reader. What Kafka seems able to do better than just about anyone else is to orchestrate the pressure's increase in such a way that it becomes intolerable at the precise instant it is released. The psychology of jokes helps account for part of the problem in teaching Kafka. We all\nknow that there is no quicker way to empty a\njoke of its peculiar magic than to try to explain it-to point out, for example, that Lou\nCostello is mistaking the proper name \"Who\"\nfor the interrogative pronoun \"who,\" etc. We\nall know the weird antipathy such explanations arouse in us, a feeling not so much of boredom as offense, like something has been blasphemed. This is a lot like the teacher's feeling at running a Kafka story through the gears of your standard undergrad-course literary analysis-plot to chart, symbols to decode, etc. Kafka, of course, would be in a unique position to appreciate the irony of submitting his\nshort stories to this kind of high-efficiency\ncritical machine, the literary equivalent of\ntearing the petals off and grinding them up\nand running the goo through a spectrometer to explain why a rose smells so pretty! Franz Kafka, after all, is the writer whose story \"Poseidon\" imagines a sea-god so overwhelmed with\nadministrative paperwork that he never gets to sail or swim, and whose \"In the Penal Colony\" conceives description as punishment and torture as edification and the ultimate critic as a\nneedled harrow whose coup de grace is a spike through the forehead. Another handicap, even for gifted students,\nis that-unlike, say, Joyce's or Pound's-the\nexformative associations Kafka's work creates are not intertextual or even historical. Kafka's evocations are, rather, unconscious and almost\nsub-archetypal, the little-kid stuff from which myths derive; this is why we tend to call even his weirdest stories nightmarish rather than surreal. Not to mention that the particular sort of\nfunniness Kafka deploys is deeply alien to kids whose neural resonances are American. The fact is that Kafka's humor has almost none of silence. the particular forms and codes of contemporary U.S. amusement. There's no recursive wordplay or verbal stunt-pilotrv, little in the way of\nwisecracks or mordant lampoon. There is no\nbody-function humor in Kafka, nor sexual entendre, nor stylized attempts to rebel by offending convention. No Pynchonian slapstick with banana peels or rapacious adenoids. No Rothish satyriasis or Barthish meta parody or arch Woody-Allen ish kvetching. There are none of\nthe ba-bing ba-bang reversals of modern sitcoms; nor are there precocious children or profane grandparents or cynically insurgent coworkers. Perhaps most alien of all, Kafka's\nauthority figures are never just hollow buffoons to be ridiculed, but are always absurd and scary and sad all at once, like \"In the Penal Colony'''s Lieutenant. My point is not that his wit is too subtle for\nU.S. students. In fact, the only halfway effective strategy I've come up with for exploring Kafka's funniness in class involves suggesting to students that much of his humor is actually sort of unsubtle, or rather anti-subtle. The claim is that Kafka's funniness depends on some kind of radical literalization of truths we\ntend to treat as metaphorical. I opine to them\nthat some of our deepest and most profound\ncollective intuitions seem to be expressible only as figures of speech, that that's why we call these figures of speech \"expressions.\" With respect to The Metamorphosis, then, I might invite students to consider what is really being expressed when we refer to someone as \"creepy\" or \"gross\" or say that somebody was forced to \"eat shit\" in his job. Or to reread \"In the Penal Colony\" in light of expressions like \"tonguelashing\" or \"She sure tore me a new asshole\" or the gnomic \"By a certain age, everybody has the face he deserves.\" Or to approach \"A Hunger Artist\" in terms of tropes like \"starved for attention\" or \"love-starved\" or the double entendre in the term \"self-denial,\" or even as innocent a factoid as that the etymological root of \"anorexia\" happens to be the\nGreek word for longing. The students usually end up engaged here, which is great, but the teacher still sort of writhes with guilt, because the comedy-as-literalization-of-metaphor tactic doesn't begin to\ncountenance the deeper alchemy by which\nKafka's comedy is always also tragedy, and this\ntragedy always also an immense and reverent\njoy. This usually leads to an excruciating hour\nduring which I backpedal and hedge and warn\nstudents that, for all their wit and exformative\nvoltage, Kafka's stories are not fundamentally\njokes, and that the rather simple and lugubrious gallows humor which marks so many of\nKafka's personal statements-stuff like his\n\"There is hope, but not for us\"-is not what his\nstories have got going on.\nWhat Kafka's stories have, rather, is a\ngrotesque and gorgeous and thoroughly modem\ncomplexity. Kafka's humor-not only not neurotic but anti-neurotic, heroically sane-is, finally, a religious humor, but religious in the\nmanner of Kierkegaard and Rilke and the\nPsalms, a harrowing spirituality against which\neven Ms. O'Connor's bloody grace seems a little bit easy, the souls at stake pre-made.\nAnd it is this, I think, that makes Kafka's\nwit inaccessible to children whom our culture\nhas trained to see jokes as entertainment and\nentertainment as reassurance) It's not that\nstudents don't \"get\" Kafka's humor but that\nwe've taught them to see humor as something\nyou get-the same way we've taught them that\na self is something you just have. No wonder\nthey cannot appreciate the really central Kafka joke-that the horrific struggle to establish\na human self results in a self whose humanity\nis inseparable from that horrific struggle. That\nour endless and impossible journey toward\nhome is in fact our home. It's hard to put into\nwords up at the blackboard, believe me. You\ncan tell them that maybe it's good they don't\n\"get\" Kafka. You can ask them to imagine his\nart as a kind of door. To envision us readers\ncoming up and pounding on this door, pounding and pounding, not just wanting admission. but needing it, we don't know what it is but we\ncan feel it, this total desperation to enter,\npounding and pushing and kicking, etc. That,\nfinally, the door opens ... and it opens outward:\nwe've been inside what we wanted all along.\nDas ist komisch.\n1 A more grad-schoolish literary-theory-type machine, on\nthe other hand, is designed to yield the conclusion that one\nhas been deluded into imagining there was any scent in the\nfirst place.\n2 There are probably whole Johns Hopkins U. Press books\nto be written on the particular kzllating function humor\nserves at this point in the U.S. psyche. Nonetheless, a\ncrude but concise way to put the whole thing is that our\npresent culture is, both developmentally and historically,\n\"adolescent.\"Since adolescence is pretty much acknowledged\nto be the single most stressful and frightening period of human development-the stage when the adulthood we claim\nto crave begins to present itself as a real and narrowing system of responsibilities and limitations2a-it's not difficult\nto see why we as a culture are so susceptible to art and entertainment whose primary function is to \"escape.\" Jokes\nare a kind of art, and since most of us Americans come to\nart essentially to forget ourselves-to pretend for a while that\nwe're not mice and all walls are parallel and the cat can be\noutrun--it's no accident that we're going to see \"A Uttle\nFable\" as not all that funny, in fact as maybe being the exact sort of downer-type death-and-taxes thing for which\n\"real\" humor serves as a respite.\n2a You think it's a coincidence that it's in college that most\nAmericans do their most serious falling-down drinking and\ndrugging and reckless driving and rampant fucking and\nmindless general Dionysian-type reveling?It's not. They're\nadolescents, and they're terrified, and they're dealing with\ntheir terror in a distinctively American way. Those naked\nhanging upside down out of their frat-house's windows\non Friday night are simply trying to get a few hours' escape\nfrom the stuff that any decent college has forced them to think\nabout all week.")
(def sentences (str/join " " ["My face is still hot, though many minutes have passed."
                "A part of me is furious at my step-mother for introducing that girl to me, with the purpose of getting us together."
                "The rest wants to place the cool end of a pistol to my temple, and squeeze."
                "Both women have left me now, and I sit glowing with shame and fury, the skin of my face tightening."
                "It feels at times that I am a glass figurine."
                "Every gaze in the room that spins in my direction sees not a man, but a vitreous tube, a beaker full of liquids roiling odiously."
                "My shame is plain on my face, a neon anti-advert, broadcasting something you'd surely live better without."
                "'Nothing is worse than being ugly,' I think, deaf to how silly and vain I sound."
                "I've been awake since approximately six."
                "There was a time when I meditated every day that I felt peace; here/now my thoughts are conveyed on a belt cranked to max speed, under pressure from some faceless authority to meet quotas and deadlines."]))
(defn atom-input [value]
  [:input {:type "text"
           :style {:font-size ".75em"}
           :value @value
           :on-change #(reset! value (-> % .-target .-value))}])
;; drop down word-suggestions as you begin typing or "no word beginning with '<search-term>' exists in this corpus."

(defn atom-textarea [value]
  [:textarea {:styles {:font-size ".7"}
              :value @value
              :on-change #(reset! value (-> % .-target .-value))}])

(defn home-page []
  (let [search-term (r/atom "")
        corpus (r/atom sentences)]
    (fn []
      [:div
       [:p [:strong "Search term: "] [atom-input search-term]]
       ;[:p [:strong "Corpus: "] [atom-textarea corpus]]
       (if (empty? @search-term)
          [:p @corpus]
         (sfx/render-tree (sfx/gen-suffix-tree @corpus @search-term)))])))

;; -------------------------
;; Initialize app

(defn mount-root []
  (r/render [home-page] (.getElementById js/document "app")))

(defn init! []
  (mount-root))
